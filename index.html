<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESLM â€“ Composition terrain</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0; font-family: Arial; background: #111; color: yellow;
    }
    header {
      display: flex; align-items: center; background: black; padding: 10px;
    }
    header img {
      height: 40px; margin-right: 10px;
    }
    .controls {
      display: flex; flex-wrap: wrap; gap: 10px; background: #222; padding: 10px;
    }
    .controls select, .controls button {
      padding: 5px 10px; font-size: 16px;
    }
    .container {
      display: flex; flex-wrap: wrap;
    }
    .player-list {
      flex: 1; min-width: 280px; background: #222; padding: 10px;
    }
    .player-list label {
      display: flex; justify-content: space-between; padding: 3px 0;
    }
    .terrain {
      flex: 2;
      position: relative;
      background: url('https://i.postimg.cc/k4jZTVr8/terrain-pro.png') no-repeat center center;
      background-size: cover;
      height: 500px;
      margin: 10px;
      border: 2px solid yellow;
    }
    .player {
      position: absolute;
      background: black;
      color: yellow;
      border: 1px solid yellow;
      border-radius: 5px;
      font-size: 12px;
      padding: 4px 6px;
      text-align: center;
      max-width: 80px;
      transform: translate(-50%, -50%);
    }
    .subs {
      background: #222; padding: 10px; margin: 10px;
    }
    @media (max-width: 600px) {
      .terrain { height: 300px; }
      .player { font-size: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://i.postimg.cc/15j1R5RH/logo9.png" alt="Logo ESLM">
    <h1>ESLM â€“ Terrain et Compo</h1>
  </header>

  <div class="controls">
    <label>Tactique :</label>
    <select id="tacticSelect">
      <option value="4-4-2">4-4-2</option>
      <option value="4-3-3">4-3-3</option>
      <option value="3-5-2">3-5-2</option>
    </select>
    <button onclick="generate()">ðŸŽ² GÃ©nÃ©rer</button>
  </div>

  <div class="container">
    <div class="player-list" id="presence-list">Chargement des joueurs...</div>
    <div id="root">Chargement terrainâ€¦</div>
  </div>

  <script type="text/babel">
    const TACTICS = {
      "4-4-2": ["G", "D", "D", "D", "D", "M", "M", "M", "M", "A", "A"],
      "4-3-3": ["G", "D", "D", "D", "D", "M", "M", "M", "A", "A", "A"],
      "3-5-2": ["G", "D", "D", "D", "M", "M", "M", "M", "M", "A", "A"]
    };

    const POSITIONS = {
      G: { top: 90 },
      D: { top: 70 },
      M: { top: 50 },
      A: { top: 30 }
    };

    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzUsOxxiz8ePK1kKOaR2rh3LxzIjdtRvIy1wwIe-NGnjsBp7m2HQxbedWUC8m8ss7pl0A/exec";

    let allPlayers = [];
    let presenceState = {};

    function updatePresenceList(players, callback) {
      const container = document.getElementById("presence-list");
      container.innerHTML = "";
      players.forEach(p => {
        const row = document.createElement("label");
        row.innerHTML = `<span>${p.nom}</span>`;
        const box = document.createElement("input");
        box.type = "checkbox";
        box.checked = String(p["prÃ©sent"]).toLowerCase() === "true";
        presenceState[p.id] = box.checked;
        box.onchange = () => {
          presenceState[p.id] = box.checked;
          callback();
        };
        row.appendChild(box);
        container.appendChild(row);
      });
    }

    function App({ tactic }) {
      const actifs = allPlayers
        .filter(p => presenceState[p.id])
        .sort((a, b) => (parseInt(b.points || 0) - parseInt(a.points || 0)));

      const compo = TACTICS[tactic];
      const titulaires = [];
      const remplaÃ§ants = [];
      const posteMap = { Gardien: "G", DÃ©fenseur: "D", Milieu: "M", Attaquant: "A" };

      const gardien = actifs.find(p => p["poste prÃ©fÃ©rÃ©"] === "Gardien");
      if (gardien) {
        titulaires.push({ ...gardien, poste: "G" });
      }

      const restants = actifs.filter(p => p.id !== gardien?.id);
      compo.forEach(pos => {
        if (pos === "G" && gardien) return;
        const prÃ©fÃ©rÃ©s = restants.find(p => posteMap[p["poste prÃ©fÃ©rÃ©"]] === pos);
        const acceptÃ©s = restants.find(p => String(p[`${pos.toLowerCase()} acceptÃ©`]).toLowerCase() === "true");
        const choisi = prÃ©fÃ©rÃ©s || acceptÃ©s;
        if (choisi) {
          titulaires.push({ ...choisi, poste: pos });
          const index = restants.findIndex(p => p.id === choisi.id);
          if (index !== -1) restants.splice(index, 1);
        }
      });

      const posteCount = { G: 0, D: 0, M: 0, A: 0 };
      return (
        <div className="terrain">
          {titulaires.map((p, i) => {
            const poste = p.poste;
            const count = posteCount[poste]++;
            const left = 20 + count * 15;
            return (
              <div key={i} className="player" style={{ top: POSITIONS[poste].top + "%", left: left + "%" }}>
                {p.nom}
              </div>
            );
          })}
        </div>
      );
    }

    function generate() {
      const tactic = document.getElementById("tacticSelect").value;
      ReactDOM.render(<App tactic={tactic} />, document.getElementById("root"));
    }

    fetch(SHEET_URL)
      .then(res => res.json())
      .then(data => {
        allPlayers = data.map(p => ({ ...p, id: p.id || p.nom }));
        updatePresenceList(allPlayers, generate);
        generate();
      });
  </script>
</body>
</html>
